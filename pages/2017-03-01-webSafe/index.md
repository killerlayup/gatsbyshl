---
title: 程序员安全设计原则 <转载>
date: "2017-03-01T22:12:03.284Z"
path: "/webSafe/"
---

安全设计原则有以下六条：

- 最小权限原则
- 纵深防御原则
- 数据与代码分离原则
- 不可预测性原则
- 验证所有用户输入原则
- 清理所有输出原则


###最小权限原则

只分配必要的权限，避免过度授权，能不开放的权限就不要开放。

白名单是非常好的一个权限控制策略，能满足需求的尽量用白名单实现。比如白名单IP等。

减少服务器的防火墙端口开放。真的需要开放的，增加IP访问限制和失效时间。可以找SA或者安全部评估需求，尽量用其他解决方案。

比如服务器权限，root确实方便，但是带来的安全风险也是普通账号不能比拟的。其实绝大部分操作都不需要root权限。真有需求的让SA协助完成也可以解决问题。或者临时测试使用的，使用完之后立刻让SA回收。淘汰的服务器也让SA尽早关机下架。笔者曾经看到有人使用root来跑web应用，一旦web应用被入侵，入侵者直接拿到了系统的root权限，导致服务被完全控制。

比如数据库权限，分离线上账号和开发账号。对于开发账号，限制写权限。虽然最安全是取消开发所有线上服务器权限，但尽量找一个效率和安全的平衡点更符合实际情况。

权限这块确实需要开发自觉控制，按需申请。权限越大，责任越大，没必要的权限尽量及早取消。

###纵深防御原则

纵深防御的意思是要在系统各个不同层次、不同方面实施安全方案；各个安全方案需要注意平衡，防止“短板”；同时找寻最合适的安全方案实施点。

我们设计和开发的系统通常使用的三层架构，web server层、app server层和db server。一般情况下，我们要求对三层分别进行安全防御和控制，在网络上和系统上分别进行防护，目的就是为了建立纵深的安全防护体系，保护存储在db中的核心数据。

同样，我们也看到过一些反面教材，有人把数据库服务器直接部署到外网，导致黑客直接入侵数据库盗走数据库中的核心数据。还有比如服务器安全做了严格设置，但是应用上存在上传文件漏洞，一样会导致服务器被攻破。

对于敏感数据，即使是保存在内网，也要注意不能随意访问和下载。处理完及时清理。

纵深防御的代价较高，需要系统的各个方面配合，尽量在各处设置障碍，最终目的是提高黑客攻击成本。

###数据与代码分离原则

各种“注入”问题，主要违背了这个原则。设计如何展现用户输入数据的时候，必须确保安全，过滤数据的同时限制数据展现形式。

前端在展示数据的时候做好安全检查，这个前端包括但不限于WEB，PC客户端，移动客户端等。用数据格式白名单也是很好的一个方案。比如只支持特定的标签，特定的文件后缀等。也符合最小权限原则。

合理的选择使用各种成熟的框架也可以避免很多安全问题，注意选用安全可靠的框架（Struts漏洞较多，不推荐）。

这里给大家展示一个反面实例，把一些数据库的链接信息和用户名密码hardcode到代码里就是典型的数据密码没有分离。

###不可预测性原则

系统中暴露出来的各种数据字段的ID不要自增（可预测）。常见的一个接口传入参数id=x，然后x遵循自增等规则（比如对应数据库索引字段），这样黑客就可能用脚本遍历id的来实现非法的接口调用。

关系型数据库中为了提高查询效率，不排斥用纯数字作为id，但是在暴露给外部用户的时候，请注意处理。比如在Dao层做一些id的加解密工作。或者干脆用UUID作为主键等。

合适的加密算法，随机数算法，哈希算法都可以实现这一原则。不要偷懒直接展现可预测的数据内容了。

淘宝曾经有一起典型的案例可以引以为戒，这个漏洞引起的根源在于以下URL

````
https://login.taobao.com/member/login_by_safe.htm?sub=&guf=&c_is_scure=&from=tbTop&type=1&style=default&minipara=&css_style=&tpl_redirect_url=&popid=&callback=jsonp81&is_ignore=&trust_alipay=&full_redirect=&user_num_id=577433811&need_sign=&from_encoding=%810%851_duplite_str=&sign=&ll=&ei=QaIBU-XLLYze0wHy-YGoCw&usg=AFQjCNGXm310YgBJj5KDzLkZzaOAUl2UnQ&bvm=bv.61535280,d.cWc&cad=rjt
````

修改 user_num_id 即可登录任意用户。如果想进入指定目标，那就得知道他的user_num_id，这里我们发现user_num_id是一串数字，很好猜测，只要不断地遍历就行了。

同样，大家可以google以下session fixation漏洞，也是基于可预测性的攻击。

###验证所有用户输入原则

几乎所有的安全漏洞都来自于用户的输入，所以只要对用户的输入做严格的限制和校验，就能极大的提高系统的安全性，避免遭受入侵。

继续以sql注入为例，sql注入就是把用户输入的数据直接和sql语句进行了拼接。如果用户的输入中注入了sql脚本，那么用户的输入将作为sql代码在数据库服务器上执行，那么后果将是灾难性的。

那么如果对用户的输入进行验证呢，这里建议大家分成以下三步


- 验证输入数据的类型，比如年龄，那么一定是数字

- 验证输入数据的长度，比如手机号，那么一定是11位的长度

- 证输入数据的白名单和黑名单，比如使用正则表达式验证用户的邮箱地址，这里再强调一下，尽量使用白名单，不要使用黑名单

最后，数据验证一定要在服务端进行验证，任何客户端的验证都是不可靠的

###清理所有输出原则

我们的应用本身，第三方中间件，服务器等都会产生一些异常信息和调试信息。这些信息对于我们跟踪程序的状态和运行情况有着非常重要的作用，但是同时对于黑客来说，这些信息的暴露也有着非常重要的意义。黑客可以通过这些信息搜集到你的应用的细节，使用这些信息可以更快的定位如何攻击你的方法。

   我们这里经常能够看到svn信息的泄露，可能有人会觉得svn信息泄露没有什么大不了的，下面我们来看一个案例。


http://www.wasu.cn/.svn/entries华数曾近由于svn的泄露，导致整个站点的源码被下载，而源码中含有用户名密码等信息。


